# 🤖 ربات پردازش ویدیو تلگرام به N8N

[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)
[![Cloudflare Workers](https://img.shields.io/badge/Cloudflare-Workers-F38020?style=for-the-badge&logo=cloudflare&logoColor=white)](https://workers.cloudflare.com/)
[![Telegram Bot API](https://img.shields.io/badge/Telegram-Bot_API-2CA5E0?style=for-the-badge&logo=telegram&logoColor=white)](https://core.telegram.org/bots/api)
[![N8N](https://img.shields.io/badge/n8n-EA4B71?style=for-the-badge&logo=n8n&logoColor=white)](https://n8n.io/)

ربات قدرتمند تلگرام بر پایه Cloudflare Workers که ویدیوهای آپلود شده را پردازش کرده و به جریان‌های کاری N8N ارسال می‌کند. برای خودکارسازی جریان کار محتوای ویدیویی، آپلود یوتیوب یا هر خط لوله پردازش ویدیو کامل است.

## ✨ ویژگی‌ها

- 🔄 **عملکرد دوگانه**: ویزارد چت خصوصی و پردازش مبتنی بر منشن در گروه
- 📹 **پردازش ویدیو**: پشتیبانی از ویدیوهای تلگرام و اسناد با نوع mime ویدیویی
- 🎯 **انتخاب هوشمند فایل**: اولویت با ویدیوهای ریپلای شده برای انتخاب دقیق
- 🔒 **امن**: اعتبارسنجی وبهوک با توکن‌های مخفی
- 🌐 **پشتیبانی کامل فارسی**: پشتیبانی کامل از زبان راست‌به‌چپ
- ⚡ **بدون سرور**: ساخته شده بر روی Cloudflare Workers برای استقرار جهانی
- 🗄️ **دارای حالت**: استفاده از Cloudflare KV برای مدیریت وضعیت گفتگو
- 🔧 **قابل توسعه**: معماری تمیز با رعایت اصول SOLID

## 📋 فهرست مطالب

- [معماری](#🏗️-معماری)
- [جریان‌های کاری](#🔄-جریان‌های-کاری)
- [نصب](#🚀-نصب)
- [پیکربندی](#⚙️-پیکربندی)
- [نحوه استفاده](#📖-نحوه-استفاده)
- [مرجع API](#🔍-مرجع-api)
- [توسعه](#🔧-توسعه)
- [استقرار](#🚀-استقرار)
- [مشارکت](#🤝-مشارکت)

## 🏗️ معماری

ربات از اصول معماری تمیز با جداسازی واضح نگرانی‌ها پیروی می‌کند:

```
src/
├── domain/           # مدل‌ها و رابط‌های تجاری اصلی
├── application/      # موارد استفاده و منطق تجاری
├── infrastructure/   # وابستگی‌های خارجی (Telegram API، N8N، ذخیره‌سازی KV)
└── worker.ts        # نقطه ورود و مسیریابی HTTP
```

### اجزا

- **لایه دامنه**: موجودیت‌های اصلی و رابط‌های مخزن
- **لایه کاربرد**: مدیریت وضعیت چت و منطق پردازش پیام
- **لایه زیرساخت**: کلاینت Telegram Bot API، کلاینت وبهوک N8N، مخزن Cloudflare KV
- **لایه ارائه**: مدیریت درخواست HTTP و اعتبارسنجی وبهوک

## 🔄 جریان‌های کاری

### جریان کار چت خصوصی (ویزارد تعاملی)

1. **شروع**: کاربر دستور `/start` را ارسال می‌کند
2. **آپلود ویدیو**: ربات درخواست فایل ویدیو می‌کند
3. **ورود عنوان**: کاربر عنوان ویدیو را ارائه می‌دهد
4. **ورود توضیحات**: کاربر توضیحات ویدیو را ارائه می‌دهد
5. **ورود تگ‌ها**: کاربر تگ‌ها را ارائه می‌دهد (جدا شده با ویرگول)
6. **تأیید**: ربات خلاصه را نشان می‌دهد و درخواست تأیید می‌کند
7. **پردازش**: پس از تأیید، payload را به جریان کاری N8N ارسال می‌کند

### جریان کار چت گروهی (مبتنی بر منشن)

1. **منشن ربات**: کاربر ربات را با قالب ساختاریافته منشن می‌کند
2. **تجزیه قالب**: ربات قالب فارسی را تجزیه می‌کند
3. **اعتبارسنجی فایل**: file_id ویدیو را با Telegram API اعتبارسنجی می‌کند
4. **پردازش مستقیم**: فوراً بدون تأیید به N8N ارسال می‌کند

#### قالب گروهی

```
@username_ربات_شما
آپلود
https://t.me/YOUR_CHANNEL/MESSAGE_ID (اختیاری)

کانال:
نام کانال

عنوان:
عنوان ویدیو

توضیح:
توضیحات ویدیو

تگ ها:
تگ۱ و تگ۲ و تگ۳
```

## 🚀 نصب

### پیش‌نیازها

- **Node.js 18+**
- **حساب Cloudflare** با Workers فعال شده
- **Wrangler CLI** نصب شده به صورت سراسری
- **توکن ربات تلگرام** از [@BotFather](https://t.me/BotFather)
- **نمونه N8N** با endpoint وبهوک

### مراحل راه‌اندازی

1. **کلون و نصب**
   ```bash
   git clone <آدرس-مخزن-شما>
   cd telegram-n8n-video-bot
   npm install
   ```

2. **ایجاد Cloudflare KV Namespace**
   ```bash
   wrangler kv namespace create CHAT_STATES
   wrangler kv namespace create CHAT_STATES --preview
   ```
   
   IDهای namespace را در `wrangler.toml` کپی کنید:
   ```toml
   [[kv_namespaces]]
   binding = "CHAT_STATES"
   id = "your-production-namespace-id"
   preview_id = "your-preview-namespace-id"
   ```

3. **پیکربندی Secrets**
   ```bash
   wrangler secret put TELEGRAM_BOT_TOKEN
   # توکن ربات خود را از @BotFather وارد کنید
   
   wrangler secret put N8N_WEBHOOK_URL
   # آدرس وبهوک N8N خود را وارد کنید
   
   wrangler secret put TELEGRAM_SECRET_TOKEN
   # اختیاری اما توصیه می‌شود: یک رشته تصادفی تولید کنید
   ```

## ⚙️ پیکربندی

### متغیرهای محیطی

| متغیر | الزامی | توضیحات |
|-------|--------|----------|
| `TELEGRAM_BOT_TOKEN` | ✅ | توکن ربات از @BotFather |
| `N8N_WEBHOOK_URL` | ✅ | endpoint وبهوک N8N شما |
| `TELEGRAM_SECRET_TOKEN` | ⚠️ | توکن اعتبارسنجی وبهوک (توصیه می‌شود) |

### راه‌اندازی ربات تلگرام

1. **ایجاد ربات**: به [@BotFather](https://t.me/BotFather) پیام دهید و `/newbot` بفرستید
2. **دریافت توکن**: توکن ارائه شده را ذخیره کنید
3. **پیکربندی ربات** (اختیاری):
   ```
   /setdescription - ربات پردازش ویدیو برای جریان‌های کاری N8N
   /setcommands - start - شروع فرآیند آپلود ویدیو
   /setprivacy - Disable (اگر می‌خواهید ربات همه پیام‌های گروه را بخواند)
   ```

## 📖 نحوه استفاده

### چت خصوصی

1. یک گفتگوی خصوصی با ربات خود شروع کنید
2. `/start` بفرستید تا ویزارد آپلود شروع شود
3. دستورالعمل‌های تعاملی را برای آپلود ویدیو و ارائه متادیتا دنبال کنید
4. جزئیات را تأیید کنید تا به N8N ارسال شود

### چت گروهی

1. ربات را به گروه خود اضافه کنید
2. مطمئن شوید که ربات می‌تواند پیام‌ها را بخواند (حالت privacy را غیرفعال کنید) یا ربات را منشن کنید
3. به پیام ویدیو پاسخ دهید یا ویدیو را در پیام خود قرار دهید
4. ربات را با قالب فارسی منشن کنید

#### نمونه استفاده گروهی

```
@username_ربات_شما
آپلود
https://t.me/mychannel/123

کانال:
بررسی‌های تکنولوژی

عنوان:
بررسی جدیدترین آیفون

توضیح:
بررسی جامع ویژگی‌ها و عملکرد جدیدترین آیفون

تگ ها:
آیفون و بررسی و تکنولوژی
```

## 🔧 توسعه

### توسعه محلی

```bash
# شروع سرور توسعه
npm run dev

# وبهوک در آدرس زیر در دسترس خواهد بود:
# http://127.0.0.1:8787/webhook
```

### استقرار

```bash
# استقرار در تولید
npm run deploy

# نظارت بر لاگ‌ها
wrangler tail
```

## 📝 مجوز

این پروژه تحت مجوز MIT منتشر شده است - فایل [LICENSE](LICENSE) را برای جزئیات ببینید.

## 🤝 مشارکت

مشارکت‌ها خوش‌آمد هستند! لطفاً برای تغییرات عمده، ابتدا یک issue باز کنید تا در مورد آنچه می‌خواهید تغییر دهید بحث کنیم.

---

**ساخته شده با ❤️ با استفاده از TypeScript، Cloudflare Workers و Telegram Bot API**
